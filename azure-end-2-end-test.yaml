pool:
  vmImage: ubuntu-latest

name: FE-SERVICE-TEST


variables:
  trivyVersion: 0.40.0
  ScanResultsPath: trivyScan

steps:
  - task: Npm@1
    displayName: 'npm install'
    inputs:
      verbose: true
    retryCountOnTaskFailure: 2

  - task: DockerInstaller@0
    displayName: 'Install Docker 17.09.0-ce'

  - bash: |
      echo 'running docker build'
      docker build --no-cache --tag bpfeapplication:CA2_TEST_V1 $(Build.SourcesDirectory)

  - script: |
      sudo apt-get install rpm
      wget -q https://github.com/aquasecurity/trivy/releases/download/v$(trivyVersion)/trivy_$(trivyVersion)_Linux-64bit.deb
      sudo dpkg -i trivy_$(trivyVersion)_Linux-64bit.deb
      mkdir $(ScanResultsPath)
      trivy image --scanners vuln --severity CRITICAL,HIGH -o $(ScanResultsPath)/results.table bpfeapplication:CA2_TEST_V1
    displayName: 'Scan using Trivy scan'


  - task: PublishHtmlReport@1
    inputs:
      reportDir: '$(ScanResultsPath)/results.table'
